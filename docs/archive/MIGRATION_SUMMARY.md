# Migration Summary: full_name → first_name + last_name, and grit_id Auto-Generation

## Overview
This migration updates the `users` table to:
1. Replace `full_name` with `first_name` and `last_name` columns
2. Make `grit_id` NOT NULL and auto-generate it for new users
3. Update all related code to use the new structure

## Files Changed

### Database Files
1. **MIGRATE_USERS_TABLE.sql** - Main migration script
   - Adds `first_name` and `last_name` columns
   - Migrates existing `full_name` data
   - Creates `generate_grit_id()` function
   - Updates `handle_new_user()` trigger function
   - Makes `grit_id` NOT NULL

2. **supabase/schema.sql** - Updated schema definition
   - Changed `full_name TEXT` to `first_name TEXT, last_name TEXT`
   - Changed `grit_id TEXT UNIQUE` to `grit_id TEXT NOT NULL UNIQUE`

### Type Definitions
3. **src/lib/types.ts**
   - Updated `User` interface: `full_name?` → `first_name?`, `last_name?`
   - Changed `grit_id?` to `grit_id` (required)

4. **src/lib/database.types.ts**
   - Updated `users` table types to match new schema

### Code Files
5. **src/lib/utils.ts**
   - Added `getFullName(firstName, lastName, fallback?)` utility function
   - Added `getFirstName(user)` utility function

6. **src/contexts/AuthContext.tsx**
   - Updated `loadUserProfile()` to use `first_name` and `last_name`
   - Updated `signUp()` to use `first_name` and `last_name` instead of `full_name`

7. **src/pages/AdminClients.tsx**
   - Updated `Client` interface
   - Updated search and display logic to use `getFullName()`

8. **src/components/Header.tsx**
   - Updated to use `first_name` and `last_name`
   - Uses `getFullName()` utility function

9. **src/pages/Dashboard.tsx**
   - Updated to use `first_name` instead of parsing `full_name`

## Migration Steps

### Step 1: Run the Migration SQL
1. Open Supabase Dashboard → SQL Editor
2. Copy and paste the contents of `MIGRATE_USERS_TABLE.sql`
3. Run the script

The script will:
- ✅ Add `first_name` and `last_name` columns
- ✅ Migrate existing `full_name` data (splits on first space)
- ✅ Create `generate_grit_id()` function
- ✅ Generate `grit_id` for existing users who don't have one
- ✅ Make `grit_id` NOT NULL
- ✅ Update the trigger function to use new structure

### Step 2: Verify Migration
Run these verification queries in Supabase SQL Editor:

```sql
-- Check the new structure
SELECT id, email, first_name, last_name, grit_id, role FROM users LIMIT 5;

-- Check if any users still have NULL grit_id (should be 0)
SELECT COUNT(*) FROM users WHERE grit_id IS NULL;

-- Check if any users still have NULL first_name or last_name
SELECT COUNT(*) FROM users WHERE first_name IS NULL OR last_name IS NULL;
```

### Step 3: Test the Application
1. Try logging in with an existing user
2. Try registering a new user
3. Verify that:
   - User profiles show first and last name correctly
   - GRIT-ID is automatically generated for new users
   - Existing users have GRIT-IDs

## GRIT-ID Format
- Format: `GRIT` + 6-digit number (e.g., `GRIT321569`)
- Range: GRIT100000 to GRIT999999
- Auto-generated by the `generate_grit_id()` function
- Guaranteed unique (checks for existing IDs before assigning)

## Breaking Changes
- `full_name` column is deprecated (but not removed - you can drop it later if needed)
- `grit_id` is now required (NOT NULL)
- All code that referenced `user.full_name` has been updated to use `getFullName(user.first_name, user.last_name)`

## Notes
- The migration preserves existing data by splitting `full_name` on the first space
- If a user's `full_name` was a single word, it will be assigned to `first_name` and `last_name` will be NULL
- The trigger function now automatically generates `grit_id` for new users
- The `generate_grit_id()` function will retry up to 100 times to find a unique ID

## Rollback (if needed)
If you need to rollback, you would need to:
1. Add back the `full_name` column
2. Concatenate `first_name` and `last_name` back to `full_name`
3. Make `grit_id` nullable again
4. Revert the code changes

However, this migration is designed to be forward-compatible and should not require rollback.









